# 14 — Variant Library (V01-V08 Controlled Bracket)

## Purpose
This document specifies the 8-variant controlled bracket system used by See It Now to systematically explore placement and scale options.

---

## Architecture Change Notice

**DEPRECATED**: The previous 10-variant creative library (safe-baseline, conservative-scale, etc.) has been replaced by an 8-variant controlled bracket system (V01-V08).

The new system:
- Uses structured intents instead of creative prompts
- Systematically varies placement mode and scale strategy
- Reduces render failures through predictable variations
- Is generated by LLM #2 (Prompt Builder) during product preparation

---

## V01-V08 Controlled Bracket

### Variant Definitions

```typescript
// config/prompts/variant-intents.config.ts

interface VariantIntent {
  id: string;           // "V01" through "V08"
  intent: string;       // Human-readable description
  placementMode: "primary" | "secondary" | "alternative";
  scaleStrategy: "best-guess" | "smaller" | "larger" | "context-heavy" | "conservative";
  scaleNote: string;    // Specific scaling instructions
  anchorRule: string | null;  // How to anchor scale reference
}

export const VARIANT_INTENTS: VariantIntent[] = [
  {
    id: "V01",
    intent: "Primary expected placement, best-guess scale, no crop",
    placementMode: "primary",
    scaleStrategy: "best-guess",
    scaleNote: "Size based on resolved_facts dimensions if known, otherwise use scale_guardrails relative to room anchors.",
    anchorRule: "Choose the nearest strong in-frame scale reference (doorway, sofa, chair, benchtop, bed) and size the product relative to it per scale_guardrails."
  },
  {
    id: "V02",
    intent: "Same placement as V01, conservative scale",
    placementMode: "primary",
    scaleStrategy: "smaller",
    scaleNote: "15-25% smaller than V01. Must be visibly smaller but still plausible.",
    anchorRule: "Use same anchor as V01."
  },
  {
    id: "V03",
    intent: "Same placement as V01, bold scale",
    placementMode: "primary",
    scaleStrategy: "larger",
    scaleNote: "15-25% larger than V01. Must be visibly larger but still plausible.",
    anchorRule: "Use same anchor as V01."
  },
  {
    id: "V04",
    intent: "Secondary valid placement mode, best-guess scale",
    placementMode: "secondary",
    scaleStrategy: "best-guess",
    scaleNote: "Same scale logic as V01, applied to a different valid placement location.",
    anchorRule: "Choose the nearest strong in-frame scale reference for this alternate location and size relative to it."
  },
  {
    id: "V05",
    intent: "Secondary placement, conservative scale",
    placementMode: "secondary",
    scaleStrategy: "smaller",
    scaleNote: "15-25% smaller than V04. Must be visibly smaller but still plausible.",
    anchorRule: "Use same anchor as V04."
  },
  {
    id: "V06",
    intent: "Alternative room anchor point, best-guess scale",
    placementMode: "alternative",
    scaleStrategy: "best-guess",
    scaleNote: "Same scale logic as V01, but using a different reference point in the room.",
    anchorRule: "Choose a DIFFERENT anchor than V01/V04 (different wall, different furniture piece) and size relative to it."
  },
  {
    id: "V07",
    intent: "Context-heavy framing for strong scale cues",
    placementMode: "primary",
    scaleStrategy: "context-heavy",
    scaleNote: "Place near multiple visible scale references to maximize scale accuracy. Do not change viewpoint.",
    anchorRule: null  // Special: uses multiple anchors
  },
  {
    id: "V08",
    intent: "Escape hatch: maximum realism, conservative scale",
    placementMode: "primary",
    scaleStrategy: "conservative",
    scaleNote: "Prioritize believability over everything. Choose conservative scale if uncertain. Strictest preservation rules.",
    anchorRule: null  // Special: whatever produces most realistic result
  }
];
```

---

## Variant Philosophy

### Scale Variations (V01-V03)

| Variant | Scale | Purpose |
|---------|-------|---------|
| V01 | Best-guess | The "expected" result - AI's best judgment |
| V02 | 15-25% smaller | Safe fallback - ensures product fits |
| V03 | 15-25% larger | Bold option - for statement pieces |

### Placement Variations (V04-V06)

| Variant | Placement | Purpose |
|---------|-----------|---------|
| V04 | Secondary | Explore alternate valid location |
| V05 | Secondary + small | Safe alternate location |
| V06 | Alternative anchor | Different reference point entirely |

### Special Cases (V07-V08)

| Variant | Purpose |
|---------|---------|
| V07 | Context-heavy: maximize scale accuracy with multiple references |
| V08 | Escape hatch: maximum realism, conservative choices |

---

## Prompt Pack Structure

LLM #2 generates a PlacementSet with exactly 8 variants:

```typescript
interface PlacementSet {
  productDescription: string;  // ~200-400 words describing the product
  variants: PlacementSetVariant[];
}

interface PlacementSetVariant {
  id: string;        // "V01" through "V08"
  placementInstruction: string; // The specific prompt text for this variant
}
```

### Example PlacementSet

```json
{
  "productDescription": "This is a reclaimed teak dining table measuring approximately 180cm long × 90cm wide × 75cm tall. It is floor-standing furniture with rigid construction and heavy weight. The material shows natural wood grain variations and weathered patina that must be preserved. Scale relative to doorways and existing dining furniture. The table should be the dominant element in dining areas.",
  "variants": [
    {
      "id": "V01",
      "placementInstruction": "Place the dining table in the center of the dining area, sized relative to the nearest doorway or existing dining furniture. Use best-guess scale based on 180cm length."
    },
    {
      "id": "V02",
      "placementInstruction": "Place the dining table in the center of the dining area, scaled 20% smaller than typical to ensure comfortable fit. Should be visibly smaller but still a substantial piece."
    },
    {
      "id": "V03",
      "placementInstruction": "Place the dining table in the center of the dining area, scaled 20% larger to create a bold, dominant presence. Should command the space while remaining physically plausible."
    },
    {
      "id": "V04",
      "placementInstruction": "Place the dining table near a window or alternate wall, using best-guess scale relative to the nearest furniture or architectural feature."
    },
    {
      "id": "V05",
      "placementInstruction": "Place the dining table in the secondary location, scaled conservatively at 15-20% smaller to ensure it fits without crowding."
    },
    {
      "id": "V06",
      "placementInstruction": "Place the dining table using a different room anchor (opposite wall, near kitchen entry) with best-guess scale relative to that anchor."
    },
    {
      "id": "V07",
      "placementInstruction": "Place the dining table where multiple scale references are visible (doorway AND existing furniture AND ceiling height). Maximize scale accuracy."
    },
    {
      "id": "V08",
      "placementInstruction": "Place the dining table in the most realistic configuration possible. Prioritize physical believability. Use conservative scale if uncertain. Strictest room preservation."
    }
  ]
}
```

---

## Storage

### In ProductAsset

The PlacementSet is stored in ProductAsset.placementSet as JSON:

```prisma
model ProductAsset {
  // ... other fields ...
  placementSet          Json?     @map("placement_set")
  placementSetVersion   Int?      @map("placement_set_version")
}
```

### In CompositeRun

Each render logs the exact placementSet used:

```prisma
model CompositeRun {
  // ... other fields ...
  placementSetHash    String   @map("placement_set_hash")
  placementSetJson    Json     @map("placement_set_json")
}
```

### In CompositeVariant

Each variant result tracks which variant was rendered:

```prisma
model CompositeVariant {
  variantId       String   @map("variant_id")  // "V01" through "V08"
  finalPromptHash String   @map("final_prompt_hash")
  // ... other fields ...
}
```

---

## API Response Format

The render endpoint returns variant metadata:

```json
{
  "run_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "complete",
  "variants": [
    {
      "id": "V01",
      "image_url": "https://storage.googleapis.com/...",
      "latency_ms": 4523
    },
    {
      "id": "V02",
      "image_url": "https://storage.googleapis.com/...",
      "latency_ms": 4891
    }
    // ... up to 8 variants
  ],
  "duration_ms": 12500,
  "version": "see-it-now-v2"
}
```

---

## Variant Selection UI (Future)

In the product edit modal, merchants will be able to:
1. View all 8 variants after a test render
2. Disable specific variants they don't want shown to customers
3. Reorder variant priority (which appears first)
4. Edit merchantOverrides to adjust the underlying facts

---

## Migration from Old System

### Deleted Files
- `config/see-it-now-variants.config.ts` — Old 10-variant creative library
- `services/see-it-now-prompt-generator.server.ts` — Old single-LLM generator

### New Files
- `config/prompts/variant-intents.config.ts` — V01-V08 definitions
- `services/see-it-now/prompt-builder.server.ts` — LLM #2 that generates PlacementSet

### Data Migration
Existing ProductAssets with old `seeItNowVariants` field will be regenerated when:
1. Product is re-prepared
2. Merchant edits placement settings
3. Prompt version is bumped

---

## Validation

### PlacementSet Validation

After LLM #2 generates a PlacementSet:

```typescript
// Validate we have exactly 8 variants
if (!pack.variants || pack.variants.length !== 8) {
  logger.warn("Expected 8 variants, got " + pack.variants?.length);
  if (pack.variants.length === 0) {
    throw new Error("No variants in prompt pack");
  }
}

// Validate each variant has required fields
for (const v of pack.variants) {
  if (!v.id || !v.variation) {
    throw new Error("Invalid variant: missing id or variation");
  }
  if (!["V01", "V02", "V03", "V04", "V05", "V06", "V07", "V08"].includes(v.id)) {
    logger.warn("Unexpected variant id: " + v.id);
  }
}
```

---

## Partial Success Handling

If some variants fail during rendering:

| Successful | Status | Behavior |
|------------|--------|----------|
| 8 | complete | All variants returned |
| 1-7 | partial | Successful variants returned, failures logged |
| 0 | failed | Error returned to client |

The system never blocks on failed variants — it returns whatever succeeded.
