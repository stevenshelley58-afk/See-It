// =============================================================================
// See It Monitor - Prisma Schema
// This is a subset of the main app schema for the Prompt Control Plane
// =============================================================================

generator client {
  provider = "prisma-client-js"
  // Windows on ARM (Node arm64) has issues loading the Node-API engine (.dll.node).
  // Use the binary engine to ensure local dev/build works on win32 arm64.
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Prompt Control Plane Enums
// =============================================================================

enum PromptStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CallStatus {
  STARTED
  SUCCEEDED
  FAILED
  TIMEOUT
}

enum AuditAction {
  PROMPT_CREATE
  PROMPT_UPDATE_DRAFT
  PROMPT_ACTIVATE
  PROMPT_ARCHIVE
  PROMPT_ROLLBACK
  RUNTIME_UPDATE
  TEST_RUN
}

// =============================================================================
// Shop (minimal - only fields needed for relations)
// =============================================================================

model Shop {
  id            String    @id @default(uuid())
  shopDomain    String    @unique @map("shop_domain")
  shopifyShopId String    @map("shopify_shop_id")
  accessToken   String    @map("access_token")
  plan          String
  monthlyQuota  Int       @map("monthly_quota")
  dailyQuota    Int       @map("daily_quota")
  settingsJson  String?   @map("settings_json")
  createdAt     DateTime  @default(now()) @map("created_at")
  uninstalledAt DateTime? @map("uninstalled_at")

  // Prompt Control Plane relations
  promptDefinitions PromptDefinition[]
  runtimeConfig     ShopRuntimeConfig?
  llmCalls          LLMCall[]
  promptTestRuns    PromptTestRun[]
  promptAuditLog    PromptAuditLog[]

  @@map("shops")
}

// =============================================================================
// Prompt Control Plane: PromptDefinition
// The prompt "type" - one per prompt name per shop
// =============================================================================

model PromptDefinition {
  id          String  @id @default(cuid())
  shopId      String  @map("shop_id")
  name        String
  description String?

  defaultModel  String @default("gemini-2.5-flash") @map("default_model")
  defaultParams Json?  @map("default_params")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop     Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  versions PromptVersion[]

  @@unique([shopId, name])
  @@index([shopId])
  @@map("prompt_definitions")
}

// =============================================================================
// Prompt Control Plane: PromptVersion
// The actual prompt content with versioning
// =============================================================================

model PromptVersion {
  id                 String       @id @default(cuid())
  promptDefinitionId String       @map("prompt_definition_id")
  version            Int
  status             PromptStatus @default(DRAFT)

  systemTemplate    String? @map("system_template") @db.Text
  developerTemplate String? @map("developer_template") @db.Text
  userTemplate      String? @map("user_template") @db.Text

  model  String?
  params Json?

  templateHash String @map("template_hash")
  changeNotes  String? @map("change_notes")

  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String    @map("created_by")
  activatedAt DateTime? @map("activated_at")
  activatedBy String?   @map("activated_by")

  promptDefinition PromptDefinition @relation(fields: [promptDefinitionId], references: [id], onDelete: Cascade)
  llmCalls         LLMCall[]

  @@unique([promptDefinitionId, version])
  @@index([promptDefinitionId, status])
  @@map("prompt_control_versions")
}

// =============================================================================
// Prompt Control Plane: ShopRuntimeConfig
// Per-tenant runtime configuration
// =============================================================================

model ShopRuntimeConfig {
  id     String @id @default(cuid())
  shopId String @unique @map("shop_id")

  maxConcurrency     Int      @default(5) @map("max_concurrency")
  forceFallbackModel String?  @map("force_fallback_model")
  modelAllowList     String[] @default([]) @map("model_allow_list")

  maxTokensOutputCap Int @default(8192) @map("max_tokens_output_cap")
  maxImageBytesCap   Int @default(20000000) @map("max_image_bytes_cap")

  dailyCostCap Decimal @default(50.00) @map("daily_cost_cap") @db.Decimal(10, 2)

  disabledPromptNames String[] @default([]) @map("disabled_prompt_names")

  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String   @map("updated_by")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_runtime_configs")
}

// =============================================================================
// Prompt Control Plane: LLMCall
// One row per model call - the core instrumentation table
// =============================================================================

model LLMCall {
  id String @id @default(cuid())

  shopId          String  @map("shop_id")
  renderRunId     String? @map("render_run_id")
  variantResultId String? @map("variant_result_id")
  testRunId       String? @map("test_run_id")

  promptName      String  @map("prompt_name")
  promptVersionId String? @map("prompt_version_id")

  model String

  resolutionHash String @map("resolution_hash")
  requestHash    String @map("request_hash")

  status     CallStatus
  startedAt  DateTime   @map("started_at")
  finishedAt DateTime?  @map("finished_at")
  latencyMs  Int?       @map("latency_ms")

  tokensIn     Int?     @map("tokens_in")
  tokensOut    Int?     @map("tokens_out")
  costEstimate Decimal? @map("cost_estimate") @db.Decimal(10, 6)

  errorType    String? @map("error_type")
  errorMessage String? @map("error_message")
  retryCount   Int     @default(0) @map("retry_count")

  providerRequestId String? @map("provider_request_id")
  providerModel     String? @map("provider_model")

  inputRef  Json? @map("input_ref")
  inputPayload Json? @map("input_payload")
  outputRef Json? @map("output_ref")

  createdAt DateTime @default(now()) @map("created_at")

  shop          Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  promptVersion PromptVersion? @relation(fields: [promptVersionId], references: [id])
  testRun       PromptTestRun? @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([shopId, createdAt])
  @@index([renderRunId])
  @@index([testRunId])
  @@index([promptName, createdAt])
  @@index([status, createdAt])
  @@map("llm_calls")
}

// =============================================================================
// Prompt Control Plane: PromptTestRun
// For test panel calls (separate from production runs)
// =============================================================================

model PromptTestRun {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  promptName      String  @map("prompt_name")
  promptVersionId String? @map("prompt_version_id")

  variables Json?
  imageRefs String[] @default([]) @map("image_refs")
  overrides Json?

  status String
  output Json?

  latencyMs    Int?     @map("latency_ms")
  tokensIn     Int?     @map("tokens_in")
  tokensOut    Int?     @map("tokens_out")
  costEstimate Decimal? @map("cost_estimate") @db.Decimal(10, 6)

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")

  shop     Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  llmCalls LLMCall[]

  @@index([shopId, promptName, createdAt])
  @@map("prompt_test_runs")
}

// =============================================================================
// Prompt Control Plane: PromptAuditLog
// Per-tenant audit trail for all changes
// =============================================================================

model PromptAuditLog {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  actor      String
  action     AuditAction
  targetType String      @map("target_type")
  targetId   String      @map("target_id")
  targetName String?     @map("target_name")

  before Json?
  after  Json?

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, createdAt])
  @@index([shopId, targetType, targetId])
  @@index([shopId, action])
  @@map("prompt_audit_log")
}
