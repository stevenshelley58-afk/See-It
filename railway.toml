[build]
builder = "nixpacks"

[build.nixpacks]
providers = ["node"]
buildPlan = """
[phases.setup]
nixPkgs = ["nodejs_20", "openssl"]
aptPkgs = ["openssl", "libssl-dev", "ca-certificates"]

[phases.install]
cmds = ["cd app && npm ci --include=dev"]

[phases.build]  
cmds = ["cd app && npx prisma generate && npm run build"]

[start]
cmd = "cd app && npm run docker-start"
"""

[[deploy.services]]
startCommand = "cd app && npm run docker-start"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[deploy]
runtime = "node"

[[deploy.services.env]]
PRISMA_CLI_BINARY_TARGETS = '["native", "debian-openssl-1.1.x"]'
