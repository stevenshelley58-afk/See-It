// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Cache bust: 2026-01-25T11:45:00Z

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Prompt Control Plane Enums
// =============================================================================

enum PromptStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum AuditAction {
  PROMPT_CREATE
  PROMPT_UPDATE_DRAFT
  PROMPT_ACTIVATE
  PROMPT_ARCHIVE
  PROMPT_ROLLBACK
  RUNTIME_UPDATE
  TEST_RUN
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Shop {
  id            String    @id @default(uuid())
  shopDomain    String    @unique @map("shop_domain")
  shopifyShopId String    @map("shopify_shop_id")
  accessToken   String    @map("access_token")
  plan          String
  monthlyQuota  Int       @map("monthly_quota")
  dailyQuota    Int       @map("daily_quota")
  settingsJson  String?   @map("settings_json")
  createdAt     DateTime  @default(now()) @map("created_at")
  uninstalledAt DateTime? @map("uninstalled_at")

  productAssets    ProductAsset[]
  roomSessions     RoomSession[]
  renderJobs       RenderJob[]
  usageDaily       UsageDaily[]
  savedRoomOwners  SavedRoomOwner[]
  savedRooms       SavedRoom[]
  seeItCaptures    SeeItCapture[]
  prepEvents       PrepEvent[]
  renderRuns       RenderRun[]
  monitorEvents    MonitorEvent[]
  monitorArtifacts MonitorArtifact[]

  // Prompt Control Plane relations
  promptDefinitions PromptDefinition[]
  runtimeConfig     ShopRuntimeConfig?
  llmCalls          LLMCall[]
  promptTestRuns    PromptTestRun[]
  promptAuditLog    PromptAuditLog[]

  @@map("shops")
}

model ProductAsset {
  id                            String    @id @default(uuid())
  shopId                        String    @map("shop_id")
  productId                     String    @map("product_id")
  productTitle                  String?   @map("product_title")
  productType                   String?   @map("product_type") // Shopify Product Type for grouping similar items
  variantId                     String?   @map("variant_id")
  sourceImageId                 String    @map("source_image_id")
  sourceImageUrl                String    @map("source_image_url")
  preparedImageUrl              String?   @map("prepared_image_url") // Cached signed URL (expires in 1hr) - legacy/fallback only. Prefer preparedImageKey for fresh URLs.
  preparedImageKey              String?   @map("prepared_image_key") // Source of truth: Permanent GCS path (e.g., "shops/.../prepared-123.png"). Use this to generate fresh signed URLs on-demand via StorageService.getSignedReadUrl()
  preparedProductImageVersion   Int       @default(0) @map("prepared_product_image_version")
  preparedProductImageUpdatedAt DateTime? @map("prepared_product_image_updated_at")
  status                        String // "unprepared" | "preparing" | "ready" | "live" | "failed"
  enabled                       Boolean   @default(false) @map("enabled")
  prepStrategy                  String    @map("prep_strategy") // "batch" | "fallback" | "manual"
  promptVersion                 Int       @map("prompt_version")
  errorMessage                  String?   @map("error_message")
  retryCount                    Int       @default(0) @map("retry_count") // Track retry attempts
  isDefault                     Boolean   @default(false) @map("is_default") // Only one default per shop+product

  // Gemini file pre-upload
  geminiFileUri       String?   @map("gemini_file_uri") // Pre-uploaded Gemini Files API URI
  geminiFileExpiresAt DateTime? @map("gemini_file_expires_at") // Gemini file expiration (48h from upload)

  // ==========================================================================
  // CANONICAL: See It Now Pipeline Fields
  // ==========================================================================
  extractedFacts    Json?     @map("extracted_facts") // LLM #1 output: ProductFacts
  merchantOverrides Json?     @map("merchant_overrides") // Merchant edits (diff only)
  resolvedFacts     Json?     @map("resolved_facts") // merged(extracted, overrides)
  placementSet      Json?     @map("placement_set") // LLM #2 output: { productDescription, variants[] }
  extractedAt       DateTime? @map("extracted_at")

  createdAt DateTime @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs RenderJob[]
  prepEvents PrepEvent[]
  renderRuns RenderRun[]

  @@index([shopId, productId])
  @@index([shopId, productId, isDefault]) // Index for finding default assets
  @@index([shopId, productType]) // Index for grouping by product type
  @@map("product_assets")
}

model RoomSession {
  id                      String    @id @default(uuid())
  shopId                  String    @map("shop_id")
  originalRoomImageUrl    String?   @map("original_room_image_url") // Legacy: Signed URL (expires in 24h)
  cleanedRoomImageUrl     String?   @map("cleaned_room_image_url") // Legacy: Signed URL (expires in 24h)
  originalRoomImageKey    String?   @map("original_room_image_key") // Stable GCS key (e.g. rooms/{shopId}/{sessionId}/room.jpg)
  cleanedRoomImageKey     String?   @map("cleaned_room_image_key") // Stable GCS key for cleaned image
  canonicalRoomImageKey   String?   @map("canonical_room_image_key") // Stable GCS key for canonical (authoritative) room image
  canonicalRoomWidth      Int?      @map("canonical_room_width") // Canonical room image width in pixels
  canonicalRoomHeight     Int?      @map("canonical_room_height") // Canonical room image height in pixels
  canonicalRoomRatioLabel String?   @map("canonical_room_ratio_label") // Gemini ratio label (e.g. "16:9")
  canonicalRoomRatioValue Float?    @map("canonical_room_ratio_value") // Gemini ratio value (e.g. 16/9)
  canonicalRoomCrop       Json?     @map("canonical_room_crop") // JSON: { ratio_label, ratio_value, crop_rect_norm: { x, y, w, h } }
  canonicalCreatedAt      DateTime? @map("canonical_created_at") // Timestamp when canonical image was generated
  geminiFileUri           String?   @map("gemini_file_uri")
  geminiFileExpiresAt     DateTime? @map("gemini_file_expires_at")
  createdAt               DateTime  @map("created_at")
  expiresAt               DateTime  @map("expires_at")
  lastUsedAt              DateTime? @map("last_used_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs RenderJob[]
  renderRuns RenderRun[]

  @@map("room_sessions")
}

model RenderJob {
  id             String    @id @default(uuid())
  shopId         String    @map("shop_id")
  productId      String    @map("product_id")
  variantId      String?   @map("variant_id")
  productAssetId String?   @map("product_asset_id")
  roomSessionId  String?   @map("room_session_id")
  placementX     Float     @map("placement_x")
  placementY     Float     @map("placement_y")
  placementScale Float     @map("placement_scale")
  stylePreset    String?   @map("style_preset")
  quality        String?   @map("quality")
  configJson     String?   @map("config_json") // Stored as JSON string
  status         String // "queued" | "processing" | "completed" | "failed"
  imageUrl       String?   @map("image_url")
  imageKey       String?   @map("image_key") // GCS key for on-demand URL generation
  modelId        String?   @map("model_id")
  promptId       String?   @map("prompt_id")
  promptVersion  Int?      @map("prompt_version")
  errorCode      String?   @map("error_code")
  errorMessage   String?   @map("error_message")
  retryCount     Int       @default(0) @map("retry_count") // Track retry attempts
  createdAt      DateTime  @map("created_at")
  completedAt    DateTime? @map("completed_at")

  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset ProductAsset? @relation(fields: [productAssetId], references: [id])
  roomSession  RoomSession?  @relation(fields: [roomSessionId], references: [id])

  @@map("render_jobs")
}

model UsageDaily {
  id               String   @id @default(uuid())
  shopId           String   @map("shop_id")
  date             DateTime
  prepRenders      Int      @default(0) @map("prep_renders")
  cleanupRenders   Int      @default(0) @map("cleanup_renders")
  compositeRenders Int      @default(0) @map("composite_renders")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, date])
  @@map("usage_daily")
}

model SavedRoomOwner {
  id        String   @id @default(uuid())
  shopId    String   @map("shop_id")
  email     String // Lowercased email address
  createdAt DateTime @default(now()) @map("created_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  savedRooms SavedRoom[]

  @@unique([shopId, email])
  @@index([shopId, email])
  @@map("saved_room_owners")
}

model SavedRoom {
  id               String   @id @default(uuid())
  shopId           String   @map("shop_id")
  ownerId          String   @map("owner_id")
  title            String? // Optional user-provided title
  originalImageKey String   @map("original_image_key") // GCS key for the original room image
  cleanedImageKey  String?  @map("cleaned_image_key") // Optional GCS key for cleaned variant
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  shop  Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  owner SavedRoomOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([shopId, ownerId])
  @@map("saved_rooms")
}

model SeeItCapture {
  id           String   @id @default(uuid())
  shopId       String   @map("shop_id")
  email        String
  productId    String   @map("product_id")
  productTitle String?  @map("product_title")
  renderJobId  String?  @map("render_job_id")
  imageUrl     String?  @map("image_url")
  createdAt    DateTime @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, email])
  @@index([shopId, createdAt])
  @@map("see_it_captures")
}

model PrepEvent {
  id        String   @id @default(uuid())
  assetId   String   @map("asset_id")
  productId String   @map("product_id")
  shopId    String   @map("shop_id")
  timestamp DateTime @default(now()) @map("timestamp")
  actorType String   @map("actor_type") // "system" | "merchant"
  actorId   String?  @map("actor_id") // nullable for system events, best-effort for merchant
  eventType String   @map("event_type")
  payload   Json     @map("payload") // JSON: { before, after, confidence?, source?, ... }

  shop         Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset ProductAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([shopId, timestamp])
  @@index([productId])
  @@map("prep_events")
}

// =============================================================================
// CANONICAL: RenderRun - One per render request
// =============================================================================

model RenderRun {
  id             String  @id @default(uuid())
  shopId         String  @map("shop_id")
  productAssetId String  @map("product_asset_id")
  roomSessionId  String? @map("room_session_id")

  traceId String @map("trace_id")

  // Image references
  preparedProductImageRef  String  @map("prepared_product_image_ref")
  preparedProductImageHash String? @map("prepared_product_image_hash")
  roomImageRef             String  @map("room_image_ref")
  roomImageHash            String? @map("room_image_hash")

  // Snapshots (complete audit trail)
  resolvedFactsSnapshot  Json   @map("resolved_facts_snapshot")
  placementSetSnapshot   Json   @map("placement_set_snapshot")
  pipelineConfigSnapshot Json   @map("pipeline_config_snapshot")
  pipelineConfigHash     String @map("pipeline_config_hash")

  // Status
  status String @default("RUNNING") // "RUNNING" | "COMPLETE" | "PARTIAL" | "FAILED"

  // Timing
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")
  totalDurationMs Int?      @map("total_duration_ms")
  waterfallMs     Json?     @map("waterfall_ms")

  // Aggregates
  successCount Int   @default(0) @map("success_count")
  failCount    Int   @default(0) @map("fail_count")
  timeoutCount Int   @default(0) @map("timeout_count")
  runTotals    Json? @map("run_totals")

  shop           Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset   ProductAsset   @relation(fields: [productAssetId], references: [id], onDelete: Cascade)
  roomSession    RoomSession?   @relation(fields: [roomSessionId], references: [id], onDelete: SetNull)
  variantResults VariantResult[]

  @@index([shopId, createdAt])
  @@index([productAssetId])
  @@index([status])
  @@index([traceId])
  @@index([pipelineConfigHash])
  @@map("render_runs")
}

// =============================================================================
// CANONICAL: VariantResult - One per variant per RenderRun
// =============================================================================

model VariantResult {
  id        String @id @default(uuid())
  runId     String @map("run_id")
  variantId String @map("variant_id") // 'V01' .. 'V08'

  status       String  // "SUCCESS" | "FAILED" | "TIMEOUT"
  imageRef     String? @map("image_ref")
  imageHash    String? @map("image_hash")
  latencyMs    Int?    @map("latency_ms")
  errorCode    String? @map("error_code")
  errorMessage String? @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  renderRun RenderRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, variantId])
  @@index([runId])
  @@index([status])
  @@map("variant_results")
}

// =============================================================================
// Observability v2: MonitorEvent - Fine-grained event stream
// =============================================================================

model MonitorEvent {
  id                 String   @id @default(uuid())
  ts                 DateTime @default(now())
  shopId             String   @map("shop_id")
  requestId          String   @map("request_id")
  runId              String?  @map("run_id")
  variantId          String?  @map("variant_id")
  traceId            String?  @map("trace_id")
  spanId             String?  @map("span_id")
  parentSpanId       String?  @map("parent_span_id")
  source             String
  type               String
  severity           String
  schemaVersion      Int      @default(1) @map("schema_version")
  payload            Json     @default("{}")
  overflowArtifactId String?  @map("overflow_artifact_id")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([requestId])
  @@index([runId])
  @@index([type, ts])
  @@map("monitor_events")
}

// =============================================================================
// Observability v2: MonitorArtifact - GCS artifact tracking with retention
// =============================================================================

model MonitorArtifact {
  id             String    @id @default(uuid())
  ts             DateTime  @default(now())
  shopId         String    @map("shop_id")
  requestId      String    @map("request_id")
  runId          String?   @map("run_id")
  variantId      String?   @map("variant_id")
  type           String
  gcsKey         String    @map("gcs_key")
  contentType    String    @map("content_type")
  byteSize       Int       @map("byte_size")
  sha256         String?
  width          Int?
  height         Int?
  retentionClass String    @default("standard") @map("retention_class")
  expiresAt      DateTime? @map("expires_at")
  meta           Json?

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([requestId])
  @@index([runId])
  @@index([type])
  @@map("monitor_artifacts")
}

// =============================================================================
// Prompt Control Plane: PromptDefinition
// The prompt "type" - one per prompt name per shop
// =============================================================================

model PromptDefinition {
  id          String  @id @default(cuid())
  shopId      String  @map("shop_id")
  name        String // e.g., "product_fact_extractor", "placement_set_generator", "composite_instruction"
  description String?

  // Defaults (fallback if version doesn't specify)
  defaultModel  String @default("gemini-2.5-flash") @map("default_model")
  defaultParams Json?  @map("default_params")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop     Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  versions PromptVersion[]

  @@unique([shopId, name])
  @@index([shopId])
  @@map("prompt_definitions")
}

// =============================================================================
// Prompt Control Plane: PromptVersion
// The actual prompt content with versioning
// =============================================================================

model PromptVersion {
  id                 String       @id @default(cuid())
  promptDefinitionId String       @map("prompt_definition_id")
  version            Int // Auto-incremented per definition (in transaction)
  status             PromptStatus @default(DRAFT)

  // Message templates (at least one required, validated in code)
  systemTemplate    String? @map("system_template") @db.Text
  developerTemplate String? @map("developer_template") @db.Text
  userTemplate      String? @map("user_template") @db.Text

  // Model config (overrides definition defaults)
  model  String?
  params Json?

  // Identity hash: SHA256 of templates + model + params
  // STORED ON CREATE, NOT RECOMPUTED
  templateHash String @map("template_hash")

  // Metadata
  changeNotes String? @map("change_notes")

  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String    @map("created_by")
  activatedAt DateTime? @map("activated_at")
  activatedBy String?   @map("activated_by")

  // Rollback chain: tracks the version that was active when this version was activated
  // Enables reliable rollback without relying on timestamp ordering
  previousActiveVersionId String? @map("previous_active_version_id")

  promptDefinition PromptDefinition @relation(fields: [promptDefinitionId], references: [id], onDelete: Cascade)
  llmCalls         LLMCall[]

  @@unique([promptDefinitionId, version])
  @@index([promptDefinitionId, status])
  @@map("prompt_control_versions")
}

// =============================================================================
// Prompt Control Plane: ShopRuntimeConfig
// Per-tenant runtime configuration
// =============================================================================

model ShopRuntimeConfig {
  id     String @id @default(cuid())
  shopId String @unique @map("shop_id")

  // Concurrency
  maxConcurrency Int @default(5) @map("max_concurrency")

  // Model controls
  forceFallbackModel String?  @map("force_fallback_model")
  modelAllowList     String[] @default([]) @map("model_allow_list")

  // Caps
  maxTokensOutputCap Int @default(8192) @map("max_tokens_output_cap")
  maxImageBytesCap   Int @default(20000000) @map("max_image_bytes_cap")

  // Budget (daily)
  dailyCostCap Decimal @default(50.00) @map("daily_cost_cap") @db.Decimal(10, 2)

  // Disabled prompts (by name)
  disabledPromptNames String[] @default([]) @map("disabled_prompt_names")

  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String   @map("updated_by")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_runtime_configs")
}

// =============================================================================
// CANONICAL: LLMCall - One row per model call
// =============================================================================

model LLMCall {
  id String @id @default(cuid())

  // Tenant context
  shopId String @map("shop_id")

  // Owner context (NO DEFAULTS - callers must populate)
  ownerType String @map("owner_type") // "COMPOSITE_RUN" | "PRODUCT_ASSET" | "TEST_RUN"
  ownerId   String @map("owner_id")
  variantId String? @map("variant_id") // null for non-variant calls

  // Prompt context (NO DEFAULTS)
  promptKey       String  @map("prompt_key") // "product_fact_extractor" | "placement_set_generator" | "composite_instruction"
  promptVersionId String? @map("prompt_version_id")

  // Identity hashes (NO DEFAULTS - callers must populate)
  callIdentityHash String  @map("call_identity_hash")
  dedupeHash       String? @map("dedupe_hash")

  // Payloads (REQUIRED for auditability)
  callSummary   Json  @map("call_summary") // { promptName, model, imageCount, promptPreview }
  debugPayload  Json  @map("debug_payload") // Full Gemini request context
  outputSummary Json? @map("output_summary") // Populated on completion

  // Status and timing
  status     String   @default("STARTED") // "STARTED" | "SUCCEEDED" | "FAILED" | "TIMEOUT"
  startedAt  DateTime @default(now()) @map("started_at")
  finishedAt DateTime? @map("finished_at")
  latencyMs  Int?      @map("latency_ms")

  // Tokens and cost
  tokensIn     Int?     @map("tokens_in")
  tokensOut    Int?     @map("tokens_out")
  costEstimate Decimal? @map("cost_estimate") @db.Decimal(10, 6)

  // Error tracking
  errorType    String? @map("error_type")
  errorMessage String? @map("error_message")

  // Provider metadata
  providerModel     String? @map("provider_model")
  providerRequestId String? @map("provider_request_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  shop          Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  promptVersion PromptVersion? @relation(fields: [promptVersionId], references: [id], onDelete: SetNull)

  @@index([shopId, createdAt])
  @@index([ownerType, ownerId])
  @@index([promptKey, createdAt])
  @@index([status, createdAt])
  @@index([callIdentityHash])
  @@index([dedupeHash])
  @@map("llm_calls")
}

// =============================================================================
// Prompt Control Plane: PromptTestRun
// For test panel calls (separate from production runs)
// =============================================================================

model PromptTestRun {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  promptName      String  @map("prompt_name")
  promptVersionId String? @map("prompt_version_id")

  // Test inputs
  variables Json?
  imageRefs String[] @default([]) @map("image_refs")

  // Overrides (full shape)
  overrides Json? // { systemTemplate?, developerTemplate?, userTemplate?, model?, params? }

  // Results
  status String // "running" | "succeeded" | "failed"
  output Json?

  // Metrics
  latencyMs    Int?     @map("latency_ms")
  tokensIn     Int?     @map("tokens_in")
  tokensOut    Int?     @map("tokens_out")
  costEstimate Decimal? @map("cost_estimate") @db.Decimal(10, 6)

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, promptName, createdAt])
  @@map("prompt_test_runs")
}

// =============================================================================
// Prompt Control Plane: PromptAuditLog
// Per-tenant audit trail for all changes
// =============================================================================

model PromptAuditLog {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  actor      String // User email or "system"
  action     AuditAction
  targetType String      @map("target_type")
  targetId   String      @map("target_id")
  targetName String?     @map("target_name")

  before Json? // State before change
  after  Json? // State after change

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, createdAt])
  @@index([shopId, targetType, targetId])
  @@index([shopId, action])
  @@map("prompt_audit_log")
}
