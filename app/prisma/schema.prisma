// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Prompt Control Plane Enums
// =============================================================================

enum PromptStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CallStatus {
  STARTED
  SUCCEEDED
  FAILED
  TIMEOUT
}

enum AuditAction {
  PROMPT_CREATE
  PROMPT_UPDATE_DRAFT
  PROMPT_ACTIVATE
  PROMPT_ARCHIVE
  PROMPT_ROLLBACK
  RUNTIME_UPDATE
  TEST_RUN
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Shop {
  id            String    @id @default(uuid())
  shopDomain    String    @unique @map("shop_domain")
  shopifyShopId String    @map("shopify_shop_id")
  accessToken   String    @map("access_token")
  plan          String
  monthlyQuota  Int       @map("monthly_quota")
  dailyQuota    Int       @map("daily_quota")
  settingsJson  String?   @map("settings_json")
  createdAt     DateTime  @default(now()) @map("created_at")
  uninstalledAt DateTime? @map("uninstalled_at")

  productAssets    ProductAsset[]
  roomSessions     RoomSession[]
  renderJobs       RenderJob[]
  usageDaily       UsageDaily[]
  savedRoomOwners  SavedRoomOwner[]
  savedRooms       SavedRoom[]
  seeItCaptures    SeeItCapture[]
  prepEvents       PrepEvent[]
  renderRuns       RenderRun[]
  monitorEvents    MonitorEvent[]
  monitorArtifacts MonitorArtifact[]

  // Prompt Control Plane relations
  promptDefinitions PromptDefinition[]
  runtimeConfig     ShopRuntimeConfig?
  llmCalls          LLMCall[]
  promptTestRuns    PromptTestRun[]
  promptAuditLog    PromptAuditLog[]

  @@map("shops")
}

model ProductAsset {
  id                            String    @id @default(uuid())
  shopId                        String    @map("shop_id")
  productId                     String    @map("product_id")
  productTitle                  String?   @map("product_title")
  productType                   String?   @map("product_type") // Shopify Product Type for grouping similar items
  variantId                     String?   @map("variant_id")
  sourceImageId                 String    @map("source_image_id")
  sourceImageUrl                String    @map("source_image_url")
  preparedImageUrl              String?   @map("prepared_image_url") // Cached signed URL (expires in 1hr) - legacy/fallback only. Prefer preparedImageKey for fresh URLs.
  preparedImageKey              String?   @map("prepared_image_key") // Source of truth: Permanent GCS path (e.g., "shops/.../prepared-123.png"). Use this to generate fresh signed URLs on-demand via StorageService.getSignedReadUrl()
  preparedProductImageVersion   Int       @default(0) @map("prepared_product_image_version")
  preparedProductImageUpdatedAt DateTime? @map("prepared_product_image_updated_at")
  status                        String // "unprepared" | "preparing" | "ready" | "live" | "failed"
  enabled                       Boolean   @default(false) @map("enabled")
  prepStrategy                  String    @map("prep_strategy") // "batch" | "fallback" | "manual"
  promptVersion                 Int       @map("prompt_version")
  errorMessage                  String?   @map("error_message")
  retryCount                    Int       @default(0) @map("retry_count") // Track retry attempts
  isDefault                     Boolean   @default(false) @map("is_default") // Only one default per shop+product

  // Gemini file pre-upload
  geminiFileUri       String?   @map("gemini_file_uri") // Pre-uploaded Gemini Files API URI
  geminiFileExpiresAt DateTime? @map("gemini_file_expires_at") // Gemini file expiration (48h from upload)

  // ==========================================================================
  // NEW: See It Now Pipeline Fields
  // ==========================================================================
  extractedFacts    Json?     @map("extracted_facts") // LLM #1 output
  merchantOverrides Json?     @map("merchant_overrides") // Merchant edits (diff only)
  resolvedFacts     Json?     @map("resolved_facts") // merged(extracted, overrides)
  promptPack        Json?     @map("prompt_pack") // LLM #2 output: { product_context, variants[] }
  promptPackVersion Int       @default(0) @map("prompt_pack_version")
  extractedAt       DateTime? @map("extracted_at")

  // ==========================================================================
  // DEPRECATED: Keep for migration, stop using
  // ==========================================================================
  renderInstructions         String?  @map("render_instructions") // Custom AI instructions for final render (optional)
  renderInstructionsSeeItNow String?  @map("render_instructions_see_it_now") // Custom AI instructions for See It Now hero shot renders (optional)
  sceneRole                  String?  @map("scene_role") // Placement rules: "Dominant" | "Integrated"
  replacementRule            String?  @map("replacement_rule") // Placement rules: "Same Role Only" | "Similar Size or Position" | "Any Blocking Object" | "None"
  allowSpaceCreation         Boolean? @map("allow_space_creation") // Placement rules: Allow minimal space creation for placement
  placementFields            Json?    @map("placement_fields") // Structured placement fields: { surface, material, orientation, shadow, dimensions: { height, width }, additionalNotes, fieldSource?: { [field]: "auto" | "merchant" } }
  // Field-level provenance (current state snapshot)
  fieldConfidence            Json?    @map("field_confidence") // JSON: { fieldName: "high" | "medium" | "low" }
  fieldSource                Json?    @map("field_source") // JSON: { fieldName: "auto" | "merchant" }
  fieldOverrides             Json?    @map("field_overrides") // JSON: { fieldName: true | false }
  fieldEvidence              Json?    @map("field_evidence") // JSON: { fieldName: "snippet/keywords/image cues" }
  // See It Now per-product prompt fields
  generatedSeeItNowPrompt    String?  @map("generated_see_it_now_prompt") // LLM-generated complete product-specific prompt
  seeItNowVariants           Json?    @map("see_it_now_variants") // JSON: Array of {id: string, prompt: string}
  detectedArchetype          String?  @map("detected_archetype") // Detected archetype: oversized_architectural, large_furniture, medium_furniture, small_homewares, wall_mounted_decor
  useGeneratedPrompt         Boolean  @default(false) @map("use_generated_prompt") // When true, uses per-product prompts instead of shop-level

  createdAt DateTime @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs RenderJob[]
  prepEvents PrepEvent[]
  renderRuns RenderRun[]

  @@index([shopId, productId])
  @@index([shopId, productId, isDefault]) // Index for finding default assets
  @@index([shopId, productType]) // Index for grouping by product type
  @@map("product_assets")
}

model RoomSession {
  id                      String    @id @default(uuid())
  shopId                  String    @map("shop_id")
  originalRoomImageUrl    String?   @map("original_room_image_url") // Legacy: Signed URL (expires in 24h)
  cleanedRoomImageUrl     String?   @map("cleaned_room_image_url") // Legacy: Signed URL (expires in 24h)
  originalRoomImageKey    String?   @map("original_room_image_key") // Stable GCS key (e.g. rooms/{shopId}/{sessionId}/room.jpg)
  cleanedRoomImageKey     String?   @map("cleaned_room_image_key") // Stable GCS key for cleaned image
  canonicalRoomImageKey   String?   @map("canonical_room_image_key") // Stable GCS key for canonical (authoritative) room image
  canonicalRoomWidth      Int?      @map("canonical_room_width") // Canonical room image width in pixels
  canonicalRoomHeight     Int?      @map("canonical_room_height") // Canonical room image height in pixels
  canonicalRoomRatioLabel String?   @map("canonical_room_ratio_label") // Gemini ratio label (e.g. "16:9")
  canonicalRoomRatioValue Float?    @map("canonical_room_ratio_value") // Gemini ratio value (e.g. 16/9)
  canonicalRoomCrop       Json?     @map("canonical_room_crop") // JSON: { ratio_label, ratio_value, crop_rect_norm: { x, y, w, h } }
  canonicalCreatedAt      DateTime? @map("canonical_created_at") // Timestamp when canonical image was generated
  geminiFileUri           String?   @map("gemini_file_uri")
  geminiFileExpiresAt     DateTime? @map("gemini_file_expires_at")
  createdAt               DateTime  @map("created_at")
  expiresAt               DateTime  @map("expires_at")
  lastUsedAt              DateTime? @map("last_used_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs RenderJob[]

  @@map("room_sessions")
}

model RenderJob {
  id             String    @id @default(uuid())
  shopId         String    @map("shop_id")
  productId      String    @map("product_id")
  variantId      String?   @map("variant_id")
  productAssetId String?   @map("product_asset_id")
  roomSessionId  String?   @map("room_session_id")
  placementX     Float     @map("placement_x")
  placementY     Float     @map("placement_y")
  placementScale Float     @map("placement_scale")
  stylePreset    String?   @map("style_preset")
  quality        String?   @map("quality")
  configJson     String?   @map("config_json") // Stored as JSON string
  status         String // "queued" | "processing" | "completed" | "failed"
  imageUrl       String?   @map("image_url")
  imageKey       String?   @map("image_key") // GCS key for on-demand URL generation
  modelId        String?   @map("model_id")
  promptId       String?   @map("prompt_id")
  promptVersion  Int?      @map("prompt_version")
  errorCode      String?   @map("error_code")
  errorMessage   String?   @map("error_message")
  retryCount     Int       @default(0) @map("retry_count") // Track retry attempts
  createdAt      DateTime  @map("created_at")
  completedAt    DateTime? @map("completed_at")

  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset ProductAsset? @relation(fields: [productAssetId], references: [id])
  roomSession  RoomSession?  @relation(fields: [roomSessionId], references: [id])

  @@map("render_jobs")
}

model UsageDaily {
  id               String   @id @default(uuid())
  shopId           String   @map("shop_id")
  date             DateTime
  prepRenders      Int      @default(0) @map("prep_renders")
  cleanupRenders   Int      @default(0) @map("cleanup_renders")
  compositeRenders Int      @default(0) @map("composite_renders")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, date])
  @@map("usage_daily")
}

model SavedRoomOwner {
  id        String   @id @default(uuid())
  shopId    String   @map("shop_id")
  email     String // Lowercased email address
  createdAt DateTime @default(now()) @map("created_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  savedRooms SavedRoom[]

  @@unique([shopId, email])
  @@index([shopId, email])
  @@map("saved_room_owners")
}

model SavedRoom {
  id               String   @id @default(uuid())
  shopId           String   @map("shop_id")
  ownerId          String   @map("owner_id")
  title            String? // Optional user-provided title
  originalImageKey String   @map("original_image_key") // GCS key for the original room image
  cleanedImageKey  String?  @map("cleaned_image_key") // Optional GCS key for cleaned variant
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  shop  Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  owner SavedRoomOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([shopId, ownerId])
  @@map("saved_rooms")
}

model SeeItCapture {
  id           String   @id @default(uuid())
  shopId       String   @map("shop_id")
  email        String
  productId    String   @map("product_id")
  productTitle String?  @map("product_title")
  renderJobId  String?  @map("render_job_id")
  imageUrl     String?  @map("image_url")
  createdAt    DateTime @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, email])
  @@index([shopId, createdAt])
  @@map("see_it_captures")
}

model PrepEvent {
  id        String   @id @default(uuid())
  assetId   String   @map("asset_id")
  productId String   @map("product_id")
  shopId    String   @map("shop_id")
  timestamp DateTime @default(now()) @map("timestamp")
  actorType String   @map("actor_type") // "system" | "merchant"
  actorId   String?  @map("actor_id") // nullable for system events, best-effort for merchant
  eventType String   @map("event_type")
  payload   Json     @map("payload") // JSON: { before, after, confidence?, source?, ... }

  shop         Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset ProductAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([shopId, timestamp])
  @@index([productId])
  @@map("prep_events")
}

// =============================================================================
// LEGACY: PromptConfigVersion - Track prompt config history (renamed from PromptVersion)
// =============================================================================

model PromptConfigVersion {
  id                    String   @id @default(uuid())
  version               Int      @unique
  extractorPromptHash   String   @map("extractor_prompt_hash")
  builderPromptHash     String   @map("builder_prompt_hash")
  globalPromptHash      String   @map("global_prompt_hash")
  variantIntentsHash    String   @map("variant_intents_hash")
  materialBehaviorsHash String   @map("material_behaviors_hash")
  scaleGuardrailsHash   String   @map("scale_guardrails_hash")
  configSnapshot        Json     @map("config_snapshot")
  createdAt             DateTime @default(now()) @map("created_at")

  renderRuns RenderRun[]

  @@map("prompt_versions")
}

// =============================================================================
// NEW: RenderRun - One per render request
// =============================================================================

model RenderRun {
  id             String  @id @default(uuid())
  shopId         String  @map("shop_id")
  productAssetId String  @map("product_asset_id")
  roomSessionId  String? @map("room_session_id")
  requestId      String  @map("request_id")

  promptPackVersion Int    @map("prompt_pack_version")
  model             String

  productImageHash String @map("product_image_hash")
  productImageMeta Json   @map("product_image_meta")
  roomImageHash    String @map("room_image_hash")
  roomImageMeta    Json   @map("room_image_meta")

  resolvedFactsHash String @map("resolved_facts_hash")
  resolvedFactsJson Json   @map("resolved_facts_json")
  promptPackHash    String @map("prompt_pack_hash")
  promptPackJson    Json   @map("prompt_pack_json")

  totalDurationMs Int?   @map("total_duration_ms")
  status          String // "partial" | "complete" | "failed"

  createdAt DateTime @default(now()) @map("created_at")

  // Observability v2 fields
  traceId          String?   @map("trace_id")
  startedAt        DateTime  @default(now()) @map("started_at")
  completedAt      DateTime? @map("completed_at")
  successCount     Int       @default(0) @map("success_count")
  failCount        Int       @default(0) @map("fail_count")
  timeoutCount     Int       @default(0) @map("timeout_count")
  telemetryDropped Boolean   @default(false) @map("telemetry_dropped")

  // ==========================================================================
  // Prompt Control Plane fields
  // ==========================================================================
  // Per-run overrides (optional)
  // Shape: { [promptName]: PromptOverride }
  promptOverrides Json? @map("prompt_overrides")

  // Complete resolved config snapshot (for audit/replay)
  // Shape: ResolvedConfigSnapshot
  resolvedConfigSnapshot Json? @map("resolved_config_snapshot")

  // Waterfall timing
  // Shape: { download_ms, prompt_build_ms, inference_ms, upload_ms, total_ms }
  waterfallMs Json? @map("waterfall_ms")

  // Aggregated totals
  // Shape: { tokens_in, tokens_out, cost_estimate, calls_total, calls_failed }
  runTotals Json? @map("run_totals")

  shop                Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset        ProductAsset        @relation(fields: [productAssetId], references: [id], onDelete: Cascade)
  promptConfigVersion PromptConfigVersion @relation(fields: [promptPackVersion], references: [version])
  variantResults      VariantResult[]
  llmCalls            LLMCall[]

  @@index([shopId, createdAt])
  @@index([productAssetId])
  @@index([promptPackVersion])
  @@index([status])
  @@index([traceId])
  @@map("render_runs")
}

// =============================================================================
// NEW: VariantResult - One per variant per RenderRun
// =============================================================================

model VariantResult {
  id              String @id @default(uuid())
  renderRunId     String @map("render_run_id")
  variantId       String @map("variant_id")
  finalPromptHash String @map("final_prompt_hash")

  status          String // "success" | "failed" | "timeout"
  latencyMs       Int?    @map("latency_ms")
  outputImageKey  String? @map("output_image_key")
  outputImageHash String? @map("output_image_hash")
  errorMessage    String? @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  // Observability v2 fields
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  providerMs       Int?      @map("provider_ms")
  uploadMs         Int?      @map("upload_ms")
  errorCode        String?   @map("error_code")
  outputArtifactId String?   @map("output_artifact_id")

  renderRun RenderRun @relation(fields: [renderRunId], references: [id], onDelete: Cascade)
  llmCalls  LLMCall[]

  @@index([renderRunId])
  @@index([variantId])
  @@index([status])
  @@map("variant_results")
}

// =============================================================================
// Observability v2: MonitorEvent - Fine-grained event stream
// =============================================================================

model MonitorEvent {
  id                 String   @id @default(uuid())
  ts                 DateTime @default(now())
  shopId             String   @map("shop_id")
  requestId          String   @map("request_id")
  runId              String?  @map("run_id")
  variantId          String?  @map("variant_id")
  traceId            String?  @map("trace_id")
  spanId             String?  @map("span_id")
  parentSpanId       String?  @map("parent_span_id")
  source             String
  type               String
  severity           String
  schemaVersion      Int      @default(1) @map("schema_version")
  payload            Json     @default("{}")
  overflowArtifactId String?  @map("overflow_artifact_id")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([requestId])
  @@index([runId])
  @@index([type, ts])
  @@map("monitor_events")
}

// =============================================================================
// Observability v2: MonitorArtifact - GCS artifact tracking with retention
// =============================================================================

model MonitorArtifact {
  id             String    @id @default(uuid())
  ts             DateTime  @default(now())
  shopId         String    @map("shop_id")
  requestId      String    @map("request_id")
  runId          String?   @map("run_id")
  variantId      String?   @map("variant_id")
  type           String
  gcsKey         String    @map("gcs_key")
  contentType    String    @map("content_type")
  byteSize       Int       @map("byte_size")
  sha256         String?
  width          Int?
  height         Int?
  retentionClass String    @default("standard") @map("retention_class")
  expiresAt      DateTime? @map("expires_at")
  meta           Json?

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([requestId])
  @@index([runId])
  @@index([type])
  @@map("monitor_artifacts")
}

// =============================================================================
// Prompt Control Plane: PromptDefinition
// The prompt "type" - one per prompt name per shop
// =============================================================================

model PromptDefinition {
  id          String  @id @default(cuid())
  shopId      String  @map("shop_id")
  name        String // e.g., "extractor", "prompt_builder", "global_render"
  description String?

  // Defaults (fallback if version doesn't specify)
  defaultModel  String @default("gemini-2.5-flash") @map("default_model")
  defaultParams Json?  @map("default_params")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop     Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  versions PromptVersion[]

  @@unique([shopId, name])
  @@index([shopId])
  @@map("prompt_definitions")
}

// =============================================================================
// Prompt Control Plane: PromptVersion
// The actual prompt content with versioning
// =============================================================================

model PromptVersion {
  id                 String       @id @default(cuid())
  promptDefinitionId String       @map("prompt_definition_id")
  version            Int // Auto-incremented per definition (in transaction)
  status             PromptStatus @default(DRAFT)

  // Message templates (at least one required, validated in code)
  systemTemplate    String? @map("system_template") @db.Text
  developerTemplate String? @map("developer_template") @db.Text
  userTemplate      String? @map("user_template") @db.Text

  // Model config (overrides definition defaults)
  model  String?
  params Json?

  // Identity hash: SHA256 of templates + model + params
  // STORED ON CREATE, NOT RECOMPUTED
  templateHash String @map("template_hash")

  // Metadata
  changeNotes String? @map("change_notes")

  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String    @map("created_by")
  activatedAt DateTime? @map("activated_at")
  activatedBy String?   @map("activated_by")

  // Rollback chain: tracks the version that was active when this version was activated
  // Enables reliable rollback without relying on timestamp ordering
  previousActiveVersionId String? @map("previous_active_version_id")

  promptDefinition PromptDefinition @relation(fields: [promptDefinitionId], references: [id], onDelete: Cascade)
  llmCalls         LLMCall[]

  @@unique([promptDefinitionId, version])
  @@index([promptDefinitionId, status])
  @@map("prompt_control_versions")
}

// =============================================================================
// Prompt Control Plane: ShopRuntimeConfig
// Per-tenant runtime configuration
// =============================================================================

model ShopRuntimeConfig {
  id     String @id @default(cuid())
  shopId String @unique @map("shop_id")

  // Concurrency
  maxConcurrency Int @default(5) @map("max_concurrency")

  // Model controls
  forceFallbackModel String?  @map("force_fallback_model")
  modelAllowList     String[] @default([]) @map("model_allow_list")

  // Caps
  maxTokensOutputCap Int @default(8192) @map("max_tokens_output_cap")
  maxImageBytesCap   Int @default(20000000) @map("max_image_bytes_cap")

  // Budget (daily)
  dailyCostCap Decimal @default(50.00) @map("daily_cost_cap") @db.Decimal(10, 2)

  // Disabled prompts (by name)
  disabledPromptNames String[] @default([]) @map("disabled_prompt_names")

  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String   @map("updated_by")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_runtime_configs")
}

// =============================================================================
// Prompt Control Plane: LLMCall
// One row per model call - the core instrumentation table
// =============================================================================

model LLMCall {
  id String @id @default(cuid())

  // Tenant context
  shopId String @map("shop_id")

  // Run context (nullable for test calls)
  renderRunId     String? @map("render_run_id")
  variantResultId String? @map("variant_result_id")
  testRunId       String? @map("test_run_id")

  // Prompt info
  promptName      String  @map("prompt_name")
  promptVersionId String? @map("prompt_version_id") // Always stored, even if overridden

  // Model info
  model String

  // Hashes for identity and deduplication
  resolutionHash String @map("resolution_hash") // Hash of rendered call
  requestHash    String @map("request_hash") // Hash for deduplication (sorted imageRefs)

  // Timing
  status     CallStatus
  startedAt  DateTime   @map("started_at")
  finishedAt DateTime?  @map("finished_at")
  latencyMs  Int?       @map("latency_ms")

  // Token usage
  tokensIn     Int?     @map("tokens_in")
  tokensOut    Int?     @map("tokens_out")
  costEstimate Decimal? @map("cost_estimate") @db.Decimal(10, 6)

  // Error tracking
  errorType    String? @map("error_type")
  errorMessage String? @map("error_message")
  retryCount   Int     @default(0) @map("retry_count")

  // Provider metadata
  providerRequestId String? @map("provider_request_id")
  providerModel     String? @map("provider_model")

  // References (truncated for storage)
  inputRef  Json? @map("input_ref") // { messageCount, imageCount, preview, resolutionHash }
  // Full request payload (for debugging / replay). May include sensitive content.
  // Stored as JSONB to allow rich inspection in See It Monitor (gated behind Reveal).
  inputPayload Json? @map("input_payload")
  outputRef Json? @map("output_ref") // { preview, length }

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  shop          Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  promptVersion PromptVersion? @relation(fields: [promptVersionId], references: [id], onDelete: SetNull)
  variantResult VariantResult? @relation(fields: [variantResultId], references: [id], onDelete: SetNull)
  renderRun     RenderRun?     @relation(fields: [renderRunId], references: [id], onDelete: Cascade)
  testRun       PromptTestRun? @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  @@index([shopId, createdAt])
  @@index([renderRunId])
  @@index([testRunId])
  @@index([variantResultId])
  @@index([promptVersionId])
  @@index([promptName, createdAt])
  @@index([status, createdAt])
  @@map("llm_calls")
}

// =============================================================================
// Prompt Control Plane: PromptTestRun
// For test panel calls (separate from production runs)
// =============================================================================

model PromptTestRun {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  promptName      String  @map("prompt_name")
  promptVersionId String? @map("prompt_version_id")

  // Test inputs
  variables Json?
  imageRefs String[] @default([]) @map("image_refs")

  // Overrides (full shape)
  overrides Json? // { systemTemplate?, developerTemplate?, userTemplate?, model?, params? }

  // Results
  status String // "running" | "succeeded" | "failed"
  output Json?

  // Metrics
  latencyMs    Int?     @map("latency_ms")
  tokensIn     Int?     @map("tokens_in")
  tokensOut    Int?     @map("tokens_out")
  costEstimate Decimal? @map("cost_estimate") @db.Decimal(10, 6)

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")

  shop     Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  llmCalls LLMCall[]

  @@index([shopId, promptName, createdAt])
  @@map("prompt_test_runs")
}

// =============================================================================
// Prompt Control Plane: PromptAuditLog
// Per-tenant audit trail for all changes
// =============================================================================

model PromptAuditLog {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  actor      String // User email or "system"
  action     AuditAction
  targetType String      @map("target_type")
  targetId   String      @map("target_id")
  targetName String?     @map("target_name")

  before Json? // State before change
  after  Json? // State after change

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, createdAt])
  @@index([shopId, targetType, targetId])
  @@index([shopId, action])
  @@map("prompt_audit_log")
}
