// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Shop {
  id            String    @id @default(uuid())
  shopDomain    String    @unique @map("shop_domain")
  shopifyShopId String    @map("shopify_shop_id")
  accessToken   String    @map("access_token")
  plan          String
  monthlyQuota  Int       @map("monthly_quota")
  dailyQuota    Int       @map("daily_quota")
  settingsJson  String?   @map("settings_json")
  createdAt     DateTime  @default(now()) @map("created_at")
  uninstalledAt DateTime? @map("uninstalled_at")

  productAssets    ProductAsset[]
  roomSessions     RoomSession[]
  renderJobs       RenderJob[]
  usageDaily       UsageDaily[]
  savedRoomOwners  SavedRoomOwner[]
  savedRooms       SavedRoom[]
  seeItCaptures    SeeItCapture[]
  prepEvents       PrepEvent[]

  @@map("shops")
}

model ProductAsset {
  id                 String   @id @default(uuid())
  shopId             String   @map("shop_id")
  productId          String   @map("product_id")
  productTitle       String?  @map("product_title")
  productType        String?  @map("product_type") // Shopify Product Type for grouping similar items
  variantId          String?  @map("variant_id")
  sourceImageId      String   @map("source_image_id")
  sourceImageUrl     String   @map("source_image_url")
  preparedImageUrl   String?  @map("prepared_image_url") // Cached signed URL (expires in 1hr) - legacy/fallback only. Prefer preparedImageKey for fresh URLs.
  preparedImageKey   String?  @map("prepared_image_key") // Source of truth: Permanent GCS path (e.g., "shops/.../prepared-123.png"). Use this to generate fresh signed URLs on-demand via StorageService.getSignedReadUrl()
  status             String // "unprepared" | "preparing" | "ready" | "live" | "failed"
  enabled            Boolean  @default(false) @map("enabled")
  prepStrategy       String   @map("prep_strategy") // "batch" | "fallback" | "manual"
  promptVersion      Int      @map("prompt_version")
  errorMessage       String?  @map("error_message")
  retryCount         Int      @default(0) @map("retry_count") // Track retry attempts
  isDefault          Boolean  @default(false) @map("is_default") // Only one default per shop+product
  renderInstructions    String?   @map("render_instructions") // Custom AI instructions for final render (optional)
  sceneRole              String?   @map("scene_role") // v2: "Dominant" | "Integrated"
  replacementRule        String?   @map("replacement_rule") // v2: "Same Role Only" | "Similar Size or Position" | "Any Blocking Object" | "None"
  allowSpaceCreation     Boolean?  @map("allow_space_creation") // v2: Allow minimal space creation for placement
  placementFields        Json?     @map("placement_fields") // Structured placement fields: { surface, material, orientation, shadow, dimensions: { height, width }, additionalNotes, fieldSource?: { [field]: "auto" | "merchant" } }
  geminiFileUri         String?   @map("gemini_file_uri") // Pre-uploaded Gemini Files API URI
  geminiFileExpiresAt   DateTime? @map("gemini_file_expires_at") // Gemini file expiration (48h from upload)
  // Field-level provenance (current state snapshot)
  fieldConfidence       Json?     @map("field_confidence") // JSON: { fieldName: "high" | "medium" | "low" }
  fieldSource           Json?     @map("field_source") // JSON: { fieldName: "auto" | "merchant" }
  fieldOverrides        Json?     @map("field_overrides") // JSON: { fieldName: true | false }
  fieldEvidence         Json?     @map("field_evidence") // JSON: { fieldName: "snippet/keywords/image cues" }
  createdAt             DateTime  @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs RenderJob[]
  prepEvents PrepEvent[]

  @@index([shopId, productId])
  @@index([shopId, productId, isDefault]) // Index for finding default assets
  @@index([shopId, productType]) // Index for grouping by product type
  @@map("product_assets")
}

model RoomSession {
  id                    String    @id @default(uuid())
  shopId                String    @map("shop_id")
  originalRoomImageUrl  String?   @map("original_room_image_url") // Legacy: Signed URL (expires in 24h)
  cleanedRoomImageUrl   String?   @map("cleaned_room_image_url")  // Legacy: Signed URL (expires in 24h)
  originalRoomImageKey  String?   @map("original_room_image_key") // Stable GCS key (e.g. rooms/{shopId}/{sessionId}/room.jpg)
  cleanedRoomImageKey   String?   @map("cleaned_room_image_key")  // Stable GCS key for cleaned image
  canonicalRoomImageKey String?   @map("canonical_room_image_key") // Stable GCS key for canonical (authoritative) room image
  canonicalRoomWidth    Int?      @map("canonical_room_width")     // Canonical room image width in pixels
  canonicalRoomHeight   Int?      @map("canonical_room_height")    // Canonical room image height in pixels
  canonicalRoomRatioLabel String? @map("canonical_room_ratio_label") // Gemini ratio label (e.g. "16:9")
  canonicalRoomRatioValue Float?  @map("canonical_room_ratio_value") // Gemini ratio value (e.g. 16/9)
  canonicalRoomCrop     Json?     @map("canonical_room_crop")      // JSON: { ratio_label, ratio_value, crop_rect_norm: { x, y, w, h } }
  canonicalCreatedAt    DateTime? @map("canonical_created_at")     // Timestamp when canonical image was generated
  geminiFileUri         String?   @map("gemini_file_uri")
  geminiFileExpiresAt   DateTime? @map("gemini_file_expires_at")
  createdAt             DateTime  @map("created_at")
  expiresAt             DateTime  @map("expires_at")
  lastUsedAt            DateTime? @map("last_used_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs RenderJob[]

  @@map("room_sessions")
}

model RenderJob {
  id             String    @id @default(uuid())
  shopId         String    @map("shop_id")
  productId      String    @map("product_id")
  variantId      String?   @map("variant_id")
  productAssetId String?   @map("product_asset_id")
  roomSessionId  String?   @map("room_session_id")
  placementX     Float     @map("placement_x")
  placementY     Float     @map("placement_y")
  placementScale Float     @map("placement_scale")
  stylePreset    String?   @map("style_preset")
  quality        String?   @map("quality")
  configJson     String?   @map("config_json") // Stored as JSON string
  status         String // "queued" | "processing" | "completed" | "failed"
  imageUrl       String?   @map("image_url")
  imageKey       String?   @map("image_key") // GCS key for on-demand URL generation
  modelId        String?   @map("model_id")
  promptId       String?   @map("prompt_id")
  promptVersion  Int?      @map("prompt_version")
  errorCode      String?   @map("error_code")
  errorMessage   String?   @map("error_message")
  retryCount     Int       @default(0) @map("retry_count") // Track retry attempts
  createdAt      DateTime  @map("created_at")
  completedAt    DateTime? @map("completed_at")

  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset ProductAsset? @relation(fields: [productAssetId], references: [id])
  roomSession  RoomSession?  @relation(fields: [roomSessionId], references: [id])

  @@map("render_jobs")
}

model UsageDaily {
  id               String   @id @default(uuid())
  shopId           String   @map("shop_id")
  date             DateTime
  prepRenders      Int      @default(0) @map("prep_renders")
  cleanupRenders   Int      @default(0) @map("cleanup_renders")
  compositeRenders Int      @default(0) @map("composite_renders")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, date])
  @@map("usage_daily")
}

model SavedRoomOwner {
  id        String      @id @default(uuid())
  shopId    String      @map("shop_id")
  email     String      // Lowercased email address
  createdAt DateTime    @default(now()) @map("created_at")

  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  savedRooms SavedRoom[]

  @@unique([shopId, email])
  @@index([shopId, email])
  @@map("saved_room_owners")
}

model SavedRoom {
  id              String          @id @default(uuid())
  shopId          String          @map("shop_id")
  ownerId         String          @map("owner_id")
  title           String?         // Optional user-provided title
  originalImageKey String         @map("original_image_key") // GCS key for the original room image
  cleanedImageKey String?         @map("cleaned_image_key")  // Optional GCS key for cleaned variant
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  shop  Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)
  owner SavedRoomOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([shopId, ownerId])
  @@map("saved_rooms")
}

model SeeItCapture {
  id            String   @id @default(uuid())
  shopId        String   @map("shop_id")
  email         String
  productId     String   @map("product_id")
  productTitle  String?  @map("product_title")
  renderJobId   String?  @map("render_job_id")
  imageUrl      String?  @map("image_url")
  createdAt     DateTime @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, email])
  @@index([shopId, createdAt])
  @@map("see_it_captures")
}

model PrepEvent {
  id        String   @id @default(uuid())
  assetId   String   @map("asset_id")
  productId String   @map("product_id")
  shopId    String   @map("shop_id")
  timestamp DateTime @default(now()) @map("timestamp")
  actorType String   @map("actor_type") // "system" | "merchant"
  actorId   String?  @map("actor_id") // nullable for system events, best-effort for merchant
  eventType String   @map("event_type")
  payload   Json     @map("payload") // JSON: { before, after, confidence?, source?, ... }

  shop       Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset ProductAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([shopId, timestamp])
  @@index([productId])
  @@map("prep_events")
}
