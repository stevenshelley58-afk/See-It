{% schema %}
{
  "name": "See It Button",
  "target": "section",
  "stylesheet": "see-it-modal.css",
  "javascript": "see-it-modal.js",
  "templates": ["product"],
  "settings": [
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "See it in your room"
    }
  ]
}
{% endschema %}

<div class="see-it-button-container" style="margin: 20px 0;">
  <button id="see-it-trigger" class="button see-it-btn" data-product-id="{{ product.id }}" data-product-image="{{ product.featured_image | image_url: width: 800 }}">
    {{ block.settings.button_label }}
  </button>
</div>

<div id="see-it-modal" class="see-it-modal hidden">
  <div class="see-it-modal-content">
    <span class="see-it-close">&times;</span>
    
    <!-- Step 0: Welcome -->
    <div id="see-it-step-welcome" class="see-it-step">
      <div class="see-it-welcome-container">
        <h2>See it in Your Home</h2>
        <p>Visualize this product in your own space using AI-powered image generation.</p>
        
        <div class="see-it-welcome-actions">
           <button id="see-it-btn-upload" class="button see-it-primary-btn">
             <span class="icon">üìÇ</span> Upload Image
           </button>
           <button id="see-it-btn-camera" class="button see-it-secondary-btn">
             <span class="icon">üì∑</span> Take Photo
           </button>
           <input type="file" id="see-it-upload" accept="image/*" style="display: none;" />
           <input type="file" id="see-it-camera-input" accept="image/*" capture="environment" style="display: none;" />
        </div>
        <div class="see-it-version-badge">See It v1.0.17</div>
      </div>
    </div>

    <!-- Step 1: Edit Room -->
    <div id="see-it-step-edit-room" class="see-it-step hidden">
      <h3>Prepare Your Room</h3>
      <p class="see-it-step-description">Paint over anything you want to remove, or skip to place the product.</p>
      
      <div class="see-it-canvas-wrapper" id="see-it-canvas-wrapper">
        <img id="see-it-room-preview" src="" alt="Room Preview" />
        <canvas id="see-it-mask-canvas"></canvas>
        <div id="see-it-cleanup-loading" class="see-it-loading-overlay hidden">
          <div class="see-it-spinner"></div>
          <p>Removing...</p>
        </div>
      </div>
      
      <!-- Simple Eraser Controls -->
      <div class="see-it-eraser-controls">
        <div class="see-it-eraser-hint">
          <span class="see-it-eraser-icon">üñåÔ∏è</span>
          <span>Draw over what to remove</span>
        </div>
        <div class="see-it-eraser-actions">
          <button id="see-it-undo-btn" class="see-it-tool-btn" disabled>
            ‚Ü©Ô∏è Undo
          </button>
          <button id="see-it-clear-btn" class="see-it-tool-btn" disabled>
            üóëÔ∏è Clear
          </button>
          <button id="see-it-remove-btn" class="button see-it-primary-btn see-it-remove-btn" disabled>
            Remove
          </button>
        </div>
      </div>

      <div class="see-it-actions-row">
        <button id="see-it-back-to-welcome" class="button see-it-text-btn">Back</button>
        <button id="see-it-confirm-room" class="button see-it-primary-btn">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 2: Place Product -->
    <div id="see-it-step-place" class="see-it-step hidden">
      <div id="see-it-canvas-container" class="see-it-interactive-canvas">
        <img id="see-it-room-image" src="" alt="Room" />
        
        <div id="see-it-product-container" class="draggable-container">
            <img id="see-it-product-image" src="" alt="Product" class="draggable-item" />
            <!-- Resize Handles -->
            <div class="resize-handle handle-tl"></div>
            <div class="resize-handle handle-tr"></div>
            <div class="resize-handle handle-bl"></div>
            <div class="resize-handle handle-br"></div>
        </div>
      </div>

      <div class="see-it-controls-panel">
        <!-- Desktop Slider (Hidden on mobile if pinch works well, but good to keep as fallback) -->
        <div class="see-it-slider-control">
            <label for="see-it-scale-slider">Size: <span id="see-it-scale-value">1.0</span>x</label>
            <input type="range" id="see-it-scale-slider" min="0.5" max="2.0" step="0.1" value="1.0" />
        </div>
        
        <div class="see-it-actions-row">
            <button id="see-it-save-room" class="button see-it-secondary-btn">Save Room</button>
            <button id="see-it-generate" class="button see-it-primary-btn">Generate View</button>
        </div>
      </div>
      
      <div id="see-it-saved-rooms-list" class="saved-rooms-scroll"></div>
    </div>

    <!-- Step 3: Result -->
    <div id="see-it-step-result" class="see-it-step hidden">
      <p id="see-it-status">Generating...</p>
      <div id="see-it-error" class="see-it-error hidden"></div>
      <div id="see-it-result"></div>
      
      <div id="see-it-actions" class="hidden see-it-actions-row">
        <button id="see-it-adjust-placement" class="button">Adjust Placement</button>
        <button id="see-it-retry" class="button see-it-retry-btn hidden">Retry</button>
        <button id="see-it-start-over" class="button see-it-text-btn">Start Over</button>
      </div>
    </div>
  </div>
</div>
