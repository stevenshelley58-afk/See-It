{% schema %}
{
  "name": "See It Button",
  "target": "section",
  "stylesheet": "see-it-modal.css",
  "javascript": "see-it-modal.js",
  "templates": ["product"],
  "settings": [
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "See it in your room"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        { "value": "primary", "label": "Primary" },
        { "value": "secondary", "label": "Secondary" }
      ],
      "default": "primary"
    }
  ]
}
{% endschema %}

{% comment %}
  See It Button - UI Consistency Update
  - Uses strictly scoped CSS classes (.see-it-widget-hook)
  - Wires button_model and button_style correctly
{% endcomment %}

{% if product != blank and product.featured_image != blank %}
  {% assign product_image_url = product.featured_image | image_url: width: 800 %}
  {% assign product_title = product.title | default: "Product" %}
  {% assign product_price = product.price | money %}
  
  {% comment %} Determine CTA class based on settings {% endcomment %}
  {% assign btn_class = 'see-it-btn-primary-pill' %}
  {% if block.settings.button_style == 'secondary' %}
    {% assign btn_class = 'see-it-btn-outline-pill' %}
  {% endif %}

  <!-- Widget Container (Card Primitive) -->
  <div class="see-it-widget-hook">
    <div class="see-it-widget-content">
      <div class="see-it-widget-text">
        <span class="see-it-widget-title">Try it in Your Home</span>
        <span class="see-it-widget-description">Get a real view of this in your space.</span>
      </div>
    </div>
    
    <!-- Widget CTA -->
    <button
      id="see-it-trigger"
      class="{{ btn_class }}"
      data-product-id="{{ product.id }}"
      data-product-handle="{{ product.handle }}"
      data-product-image="{{ product_image_url }}"
      data-product-title="{{ product_title | escape }}"
      data-product-price="{{ product_price | escape }}"
      data-shop-domain="{{ shop.domain }}"
      type="button"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2 L22 7 L22 17 L12 22 L2 17 L2 7 Z" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M12 2 L12 22" stroke="currentColor" stroke-width="2"/>
        <path d="M22 7 L12 12 L2 7" stroke="currentColor" stroke-width="2"/>
      </svg>
      {{ block.settings.button_label | default: "See it in your room" }}
    </button>
  </div>

  <!-- Modal Markup (Hidden by default) -->
  <div id="see-it-modal" class="see-it-modal hidden">
    <div class="see-it-modal-content">
      <!-- Error boundary container -->
      <div id="see-it-global-error" class="see-it-hidden"></div>

      <!-- ENTRY SCREEN -->
      <div id="see-it-screen-entry" class="see-it-screen see-it-screen-entry active">
         <!-- Safe Area Header (Top Row) -->
         <div class="see-it-header">
            <button class="see-it-btn-icon" id="see-it-close-entry" aria-label="Close">
               <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <span class="see-it-header-title">PREVIEW</span>
            <div style="width: 40px;"></div> <!-- Spacer -->
         </div>

         <div class="see-it-entry-content">
            <!-- Compact Product Card (Context) -->
            <div class="see-it-product-card-compact">
               <img src="{{ product_image_url }}" alt="">
               <div class="see-it-product-info-compact">
                  <p class="see-it-product-title-compact">{{ product_title }}</p>
                  <p class="see-it-product-price-compact">{{ product_price }}</p>
               </div>
            </div>

            <h1 class="see-it-entry-title">See it in your space</h1>
            <p class="see-it-entry-description">Take a photo of your room to see how this looks instantly.</p>

            <div class="see-it-entry-actions">
               <button class="see-it-btn-primary-pill" id="see-it-btn-take-photo">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/></svg>
                  Take Photo
               </button>
               <button class="see-it-btn-outline-pill" id="see-it-btn-upload">Upload</button>
            </div>
         </div>
      </div>

      <!-- PREPARE SCREEN -->
      <div id="see-it-screen-prepare" class="see-it-screen see-it-screen-prepare">
         <div class="see-it-header">
            <button class="see-it-btn-icon" id="see-it-back-prepare" aria-label="Back">
               <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <span class="see-it-header-title">PREPARE ROOM</span>
            <div style="width: 40px;"></div>
         </div>

         <div class="see-it-prepare-room-container">
            <img id="see-it-room-preview" class="see-it-room-preview" src="" alt="Room">
            <canvas id="see-it-mask-canvas" class="see-it-mask-canvas"></canvas>
         </div>

         <div class="see-it-prepare-bottom">
            <p style="text-align: center; color: var(--si-muted); font-size: 14px; margin: 0;">Draw over objects to remove them.</p>
            <div class="see-it-prepare-actions-row">
               <button class="see-it-btn-outline-pill" id="see-it-undo-btn" disabled>Undo</button>
               <button class="see-it-btn-outline-pill" id="see-it-remove-btn">Erase</button>
               <button class="see-it-btn-primary-pill" id="see-it-confirm-room">Continue</button>
            </div>
         </div>
      </div>

      <!-- POSITION SCREEN -->
      <div id="see-it-screen-position" class="see-it-screen see-it-screen-position">
         <div class="see-it-header">
            <button class="see-it-btn-icon" id="see-it-back-position" aria-label="Back">
               <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <span class="see-it-header-title">POSITION</span>
            <div style="width: 40px;"></div>
         </div>

         <!-- Room & Product Canvas Area -->
         <div class="see-it-prepare-room-container" id="see-it-position-container">
             <img id="see-it-room-image" src="" alt="Room" style="width: 100%; height: 100%; object-fit: contain;">
             <!-- Product Overlay (draggable & resizable) -->
             <div id="see-it-product-overlay" class="see-it-product-overlay">
                 <img id="see-it-product-image" src="" alt="Product" draggable="false">
                 <!-- Resize handles -->
                 <div class="see-it-resize-handle see-it-resize-nw"></div>
                 <div class="see-it-resize-handle see-it-resize-ne"></div>
                 <div class="see-it-resize-handle see-it-resize-sw"></div>
                 <div class="see-it-resize-handle see-it-resize-se"></div>
             </div>
         </div>

         <div class="see-it-position-controls">
            <div class="see-it-save-room-row">
               <span>Save room for later</span>
               <!-- Native checkbox for simplicity until custom toggle needed -->
               <input type="checkbox" id="see-it-save-room-toggle" style="width: 20px; height: 20px; accent-color: var(--si-cta);">
            </div>
            <button class="see-it-btn-primary-pill" id="see-it-generate">Generate View</button>
         </div>
      </div>

      <!-- RESULT SCREEN -->
      <div id="see-it-screen-result" class="see-it-screen see-it-screen-result">
          <div class="see-it-header">
            <button class="see-it-btn-icon" id="see-it-close-result" aria-label="Close">
               <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <span class="see-it-header-title">RESULT</span>
            <div style="width: 40px;"></div> <!-- Spacer -->
         </div>

         <div class="see-it-prepare-room-container" style="flex-direction: column;">
             <div class="see-it-result-success">Complete</div>
             <img id="see-it-result-image" src="" alt="Result" style="max-height: 80%; max-width: 100%;">
         </div>

         <div class="see-it-position-controls">
            <button class="see-it-btn-primary-pill" id="see-it-share">Share Result</button>
            <button class="see-it-btn-outline-pill" id="see-it-new-room">Try Another</button>
         </div>
      </div>
      
      <!-- Hidden File Inputs -->
      <input type="file" id="see-it-upload-input" accept="image/*" style="display: none;" />
      <input type="file" id="see-it-camera-input" accept="image/*" capture="environment" style="display: none;" />

    </div>
  </div>
{% endif %}
