{% schema %}
{
  "name": "See It Button",
  "target": "section",
  "stylesheet": "see-it-modal.css",
  "javascript": "see-it-modal.js",
  "templates": ["product"],
  "settings": [
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "See it in your room"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        { "value": "primary", "label": "Primary" },
        { "value": "secondary", "label": "Secondary" }
      ],
      "default": "primary"
    }
  ]
}
{% endschema %}

{% comment %}
  See It Button - Allows customers to visualize products in their room
  Requirements:
  - Must be on a product template
  - Product must have a featured image
{% endcomment %}

{% if product != blank and product.featured_image != blank %}
  {% assign product_image_url = product.featured_image | image_url: width: 800 %}
  {% assign product_title = product.title | default: "Product" %}
  {% assign product_price = product.price | money %}
  {% assign button_class = 'see-it-primary-btn' %}
  {% if block.settings.button_style == 'secondary' %}
    {% assign button_class = 'see-it-secondary-btn' %}
  {% endif %}

  <div class="see-it-widget-hook">
    <h3 class="see-it-widget-title">What if you could see it at home first?</h3>
    <button
      id="see-it-trigger"
      class="see-it-widget-btn"
      data-product-id="{{ product.id }}"
      data-product-handle="{{ product.handle }}"
      data-product-image="{{ product_image_url }}"
      data-product-title="{{ product_title }}"
      data-product-price="{{ product_price }}"
      data-shop-domain="{{ shop.domain }}"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
        <circle cx="12" cy="13" r="4"/>
      </svg>
      Try it now
    </button>
  </div>

  <!-- Modal -->
  <div id="see-it-modal" class="see-it-modal hidden">
    <div class="see-it-modal-content">
      <div id="see-it-global-error" class="see-it-error hidden"></div>

      <!-- Screen 1: Entry -->
      <div id="see-it-screen-entry" class="see-it-screen see-it-screen-entry active">
        <!-- Mobile Layout -->
        <div class="see-it-entry-mobile">
          <!-- Dark gradient header with product card -->
          <div class="see-it-entry-header-dark">
            <div class="see-it-entry-header-top">
              <button class="see-it-btn-close-light" id="see-it-close-entry">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <span class="see-it-entry-header-label">PREVIEW</span>
              <div class="see-it-header-spacer"></div>
            </div>
            
            <!-- Product card inside dark area -->
            <div class="see-it-product-card-compact">
              <div class="see-it-product-image-compact">
                <img id="see-it-entry-product-image" src="{{ product_image_url }}" alt="{{ product_title }}" />
              </div>
            </div>
          </div>

          <!-- Product info below dark header -->
          <div class="see-it-product-info-below">
            <p class="see-it-product-title" id="see-it-entry-product-title">{{ product_title }}</p>
            <p class="see-it-product-price" id="see-it-entry-product-price">{{ product_price }}</p>
          </div>

          <!-- Content -->
          <div class="see-it-entry-content">
            <h1 class="see-it-entry-title">See it in your space</h1>
            <p class="see-it-entry-description">Snap a photo of your room.</p>

            <button class="see-it-btn-primary-pill" id="see-it-btn-take-photo">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/>
              </svg>
              Take Photo
            </button>

            <div class="see-it-entry-actions-pill">
              <button class="see-it-btn-outline-pill" id="see-it-btn-upload">Upload</button>
              <button class="see-it-btn-outline-pill" id="see-it-btn-saved">Saved</button>
            </div>
          </div>

          <!-- Step indicator -->
          <div class="see-it-step-indicator">
            <p class="see-it-step-number">1. Entry</p>
            <p class="see-it-step-hint">Choose how to add room</p>
          </div>
        </div>

        <!-- Desktop Header (separate for desktop) -->
        <div class="see-it-header see-it-header-desktop-only">
          <button class="see-it-btn-close" id="see-it-close-entry-desktop">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
          <span class="see-it-header-title see-it-header-title-desktop">See It In Your Room</span>
          <div class="see-it-header-spacer"></div>
        </div>

        <!-- Desktop Layout -->
        <div class="see-it-entry-desktop">
          <!-- Left: Product -->
          <div class="see-it-entry-desktop-left">
            <div class="see-it-product-card">
              <div class="see-it-product-image-container">
                <img id="see-it-entry-product-image-desktop" src="{{ product_image_url }}" alt="{{ product_title }}" />
              </div>
              <div class="see-it-product-info">
                <p class="see-it-product-title" id="see-it-entry-product-title-desktop">{{ product_title }}</p>
                <p class="see-it-product-price" id="see-it-entry-product-price-desktop">{{ product_price }}</p>
              </div>
            </div>
          </div>

          <!-- Right: Options -->
          <div class="see-it-entry-desktop-right">
            <div class="see-it-entry-content">
              <h1 class="see-it-entry-title">See it in your space</h1>
              <p class="see-it-entry-description">Take a photo of your room and see exactly how this piece looks.</p>

              <button class="see-it-btn-primary" id="see-it-btn-take-photo-desktop">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/>
                </svg>
                Take Photo
              </button>

              <div class="see-it-entry-actions">
                <button class="see-it-btn-secondary" id="see-it-btn-upload-desktop">Upload Photo</button>
                <button class="see-it-btn-secondary" id="see-it-btn-saved-desktop">Saved Rooms</button>
              </div>

              <p class="see-it-entry-time-hint">Takes about 20 seconds</p>
            </div>
          </div>
        </div>

        <!-- Hidden inputs -->
        <input type="file" id="see-it-upload-input" accept="image/*" style="display: none;" />
        <input type="file" id="see-it-camera-input" accept="image/*" capture="environment" style="display: none;" />
      </div>

      <!-- Screen 2: Prepare Room -->
      <div id="see-it-screen-prepare" class="see-it-screen see-it-screen-prepare">
        <!-- Mobile Layout -->
        <div class="see-it-prepare-mobile">
          <!-- Header -->
          <div class="see-it-screen-header">
            <button class="see-it-btn-back-light" id="see-it-back-prepare">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
              </svg>
              <span>Back</span>
            </button>
            <span class="see-it-screen-header-title">PREPARE</span>
            <div class="see-it-header-spacer"></div>
          </div>

          <!-- Room photo container -->
          <div class="see-it-prepare-room-container">
            <div class="see-it-room-image-wrapper">
              <img id="see-it-room-preview" src="" alt="Room Preview" />
              <canvas id="see-it-mask-canvas"></canvas>
              
              <!-- Product preview in room -->
              <div class="see-it-prepare-product-preview">
                <img src="{{ product_image_url }}" alt="{{ product_title }}" />
              </div>
              
              <!-- Paint stroke indicator -->
              <div id="see-it-paint-indicator" class="see-it-paint-indicator hidden"></div>
            </div>
          </div>

          <!-- Paint controls -->
          <div class="see-it-prepare-controls">
            <p class="see-it-prepare-hint">Paint over anything to remove, or skip.</p>

            <!-- Paint tools row -->
            <div class="see-it-paint-tools">
              <div class="see-it-brush-indicator">
                <div class="see-it-brush-circle">
                  <div class="see-it-brush-dot"></div>
                </div>
                <span>Paint to remove</span>
              </div>
              <button class="see-it-tool-btn-outline" id="see-it-undo-btn" disabled>Undo</button>
              <button class="see-it-tool-btn-outline" id="see-it-clear-btn" disabled>Clear</button>
            </div>

            <!-- Action buttons -->
            <div class="see-it-prepare-actions-new">
              <button class="see-it-btn-outline-pill" id="see-it-remove-btn" disabled>Remove</button>
              <button class="see-it-btn-primary-pill see-it-btn-primary-pill-sm" id="see-it-confirm-room">Continue</button>
            </div>
          </div>

          <!-- Step indicator -->
          <div class="see-it-step-indicator">
            <p class="see-it-step-number">2. Prepare Room</p>
            <p class="see-it-step-hint">Remove objects (optional)</p>
          </div>
        </div>

        <!-- Desktop Layout -->
        <div class="see-it-prepare-desktop">
          <!-- Left: Room image -->
          <div class="see-it-prepare-desktop-left">
            <div class="see-it-prepare-room-container">
              <div class="see-it-room-image-wrapper">
                <img id="see-it-room-preview-desktop" src="" alt="Room Preview" />
                <canvas id="see-it-mask-canvas-desktop"></canvas>
                
                <!-- Example paint stroke indicator (shown when drawing) -->
                <div id="see-it-paint-indicator-desktop" class="see-it-paint-indicator hidden"></div>
              </div>
            </div>
          </div>

          <!-- Right: Controls -->
          <div class="see-it-prepare-desktop-right">
            <div class="see-it-prepare-controls">
              <h2 class="see-it-prepare-controls-title">Remove objects</h2>
              <p class="see-it-prepare-hint">Paint over anything you want removed from the photo, or skip this step.</p>

              <!-- Brush indicator -->
              <div class="see-it-brush-indicator-desktop">
                <div class="see-it-brush-circle">
                  <div class="see-it-brush-dot"></div>
                </div>
                <span>Brush tool</span>
              </div>

              <div class="see-it-prepare-tool-actions">
                <button class="see-it-tool-btn" id="see-it-undo-btn-desktop" disabled>Undo</button>
                <button class="see-it-tool-btn" id="see-it-clear-btn-desktop" disabled>Clear</button>
              </div>

              <div class="see-it-prepare-actions">
                <button class="see-it-btn-secondary" id="see-it-remove-btn-desktop" disabled>Remove Selected</button>
                <button class="see-it-btn-primary" id="see-it-confirm-room-desktop">Continue</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading overlay -->
        <div id="see-it-cleanup-loading" class="see-it-loading-overlay hidden">
          <div class="see-it-spinner"></div>
          <p>Removing...</p>
        </div>

        <!-- Upload indicator -->
        <div id="see-it-upload-indicator" class="see-it-upload-badge hidden">
          <span class="see-it-upload-dot"></span>
          Uploading...
        </div>
      </div>

      <!-- Screen 3: Position Product -->
      <div id="see-it-screen-position" class="see-it-screen see-it-screen-position">
        <!-- Mobile Layout -->
        <div class="see-it-position-mobile">
          <!-- Header -->
          <div class="see-it-screen-header">
            <button class="see-it-btn-back-light" id="see-it-back-position">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
              </svg>
              <span>Back</span>
            </button>
            <span class="see-it-screen-header-title">POSITION</span>
            <div class="see-it-header-spacer"></div>
          </div>

          <!-- Room with product -->
          <div class="see-it-position-room-container">
            <div class="see-it-room-image-wrapper">
              <img id="see-it-room-image" src="" alt="Room" />
              
              <!-- Product overlay -->
              <div id="see-it-product-container" class="see-it-product-overlay">
                <img id="see-it-product-image" src="" alt="Product" class="see-it-product-overlay-img" />
                <!-- Resize handles for desktop -->
                <div class="resize-handle handle-tl"></div>
                <div class="resize-handle handle-tr"></div>
                <div class="resize-handle handle-bl"></div>
                <div class="resize-handle handle-br"></div>
              </div>

              <!-- Instruction pill -->
              <div class="see-it-instruction-pill">
                <p>Drag to move · Pinch to resize</p>
              </div>
            </div>
          </div>

          <!-- Controls -->
          <div class="see-it-position-controls">
            <!-- Save room toggle -->
            <label class="see-it-save-room-toggle-new">
              <span>Save room for later</span>
              <div class="see-it-toggle-switch">
                <input type="checkbox" id="see-it-save-room-toggle" />
                <div class="see-it-toggle-slider"></div>
              </div>
            </label>

            <!-- Generate button -->
            <button class="see-it-btn-primary-pill" id="see-it-generate">Generate</button>
          </div>

          <!-- Step indicator -->
          <div class="see-it-step-indicator">
            <p class="see-it-step-number">3. Position</p>
            <p class="see-it-step-hint">Place product, then generate</p>
          </div>
        </div>

        <!-- Desktop Layout -->
        <div class="see-it-position-desktop">
          <!-- Left: Room with product -->
          <div class="see-it-position-desktop-left">
            <div class="see-it-position-room-container">
              <div class="see-it-room-image-wrapper">
                <img id="see-it-room-image-desktop" src="" alt="Room" />
                
                <!-- Product overlay -->
                <div id="see-it-product-container-desktop" class="see-it-product-overlay">
                  <img id="see-it-product-image-desktop" src="" alt="Product" class="see-it-product-overlay-img" />
                  <!-- Resize handles for desktop -->
                  <div class="resize-handle handle-tl"></div>
                  <div class="resize-handle handle-tr"></div>
                  <div class="resize-handle handle-bl"></div>
                  <div class="resize-handle handle-br"></div>
                </div>

                <!-- Instruction pill -->
                <div class="see-it-instruction-pill">
                  <p>Drag to move · Drag corners to resize</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Controls -->
          <div class="see-it-position-desktop-right">
            <div class="see-it-position-controls">
              <h2 class="see-it-position-controls-title">Position the mirror</h2>
              <p class="see-it-position-controls-hint">Drag it where you want it. Drag the corners to resize.</p>

              <!-- Save room toggle -->
              <label class="see-it-save-room-toggle">
                <span>Save room for later</span>
                <div class="see-it-toggle-switch">
                  <input type="checkbox" id="see-it-save-room-toggle-desktop" />
                  <div class="see-it-toggle-slider"></div>
                </div>
              </label>

              <!-- Generate button -->
              <button class="see-it-btn-primary" id="see-it-generate-desktop">Generate</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Screen 4: Result -->
      <div id="see-it-screen-result" class="see-it-screen see-it-screen-result">
        <!-- Mobile Layout -->
        <div class="see-it-result-mobile">
          <!-- Result image area -->
          <div class="see-it-result-container-new">
            <!-- Close button -->
            <button class="see-it-btn-close-result" id="see-it-close-result">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>

            <!-- Success badge -->
            <div class="see-it-success-badge-new">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
              </svg>
              Complete
            </div>

            <!-- Product in result -->
            <div class="see-it-result-product-display">
              <img src="{{ product_image_url }}" alt="{{ product_title }}" />
            </div>

            <!-- Room result image -->
            <div class="see-it-result-room-display">
              <img id="see-it-result-image" src="" alt="Result" />
            </div>
          </div>

          <!-- Actions -->
          <div class="see-it-result-actions-new">
            <button class="see-it-btn-primary-pill" id="see-it-share">Share</button>
            <div class="see-it-result-secondary-actions-new">
              <button class="see-it-btn-outline-pill" id="see-it-adjust">Adjust</button>
              <button class="see-it-btn-outline-pill" id="see-it-new-room">New Room</button>
            </div>
          </div>
        </div>

        <!-- Desktop Layout -->
        <div class="see-it-result-desktop">
          <!-- Left: Result image -->
          <div class="see-it-result-desktop-left">
            <div class="see-it-result-container">
              <div class="see-it-result-image-wrapper">
                <img id="see-it-result-image-desktop" src="" alt="Result" />

                <!-- Success badge -->
                <div class="see-it-success-badge">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                  </svg>
                  Complete
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Actions -->
          <div class="see-it-result-desktop-right">
            <div class="see-it-result-actions">
              <h2 class="see-it-result-actions-title">Your room</h2>
              <p class="see-it-result-actions-hint">Here's how the <span id="see-it-result-product-title-text">{{ product_title }}</span> looks in your space.</p>

              <!-- Product summary -->
              <div class="see-it-result-product-summary">
                <div class="see-it-result-product-image">
                  <img id="see-it-result-product-image" src="{{ product_image_url }}" alt="{{ product_title }}" />
                </div>
                <div class="see-it-result-product-info">
                  <p class="see-it-result-product-title" id="see-it-result-product-title">{{ product_title }}</p>
                  <p class="see-it-result-product-price" id="see-it-result-product-price">{{ product_price }}</p>
                </div>
              </div>

              <button class="see-it-btn-primary" id="see-it-share-desktop">Share Image</button>
              <button class="see-it-btn-secondary" id="see-it-new-room-desktop">Try Another Room</button>
            </div>
          </div>
        </div>

        <!-- Status text (shown during generation) -->
        <div id="see-it-status-text" class="see-it-status-text hidden">
          <p id="see-it-status">Generating...</p>
        </div>

        <!-- Error display -->
        <div id="see-it-error" class="see-it-error hidden"></div>
      </div>

      <!-- Email capture modal (hidden until needed) -->
      <div id="see-it-email-modal" class="see-it-email-modal hidden">
        <div class="see-it-email-modal-content">
          <h3>Save your rooms</h3>
          <p>Enter your email to save rooms for later use.</p>
          <input type="email" id="see-it-email-input" placeholder="your@email.com" />
          <div class="see-it-email-actions">
            <button class="see-it-btn-secondary" id="see-it-email-cancel">Cancel</button>
            <button class="see-it-btn-primary" id="see-it-email-submit">Save</button>
          </div>
        </div>
      </div>

      <!-- Saved rooms list modal (hidden until needed) -->
      <div id="see-it-saved-rooms-modal" class="see-it-email-modal hidden">
        <div class="see-it-email-modal-content">
          <h3>Saved Rooms</h3>
          <div id="see-it-saved-rooms-list" class="see-it-saved-rooms-list"></div>
          <button class="see-it-btn-secondary" id="see-it-saved-rooms-close">Close</button>
        </div>
      </div>
    </div>
  </div>
{% else %}
  {% comment %}
    Product or featured image not available - render nothing
    This prevents JavaScript errors from missing DOM elements
  {% endcomment %}
{% endif %}